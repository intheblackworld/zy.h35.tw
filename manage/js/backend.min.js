function removeSaveMsg(e){var t,a=e;t=setTimeout(function(){a.status.save=null,a.msg.save=null,clearTimeout(t)},3600)}function range(e,t){return Array(t-e+1).fill().map(function(t,a){return e+a})}function pad_left(e,t){return(e+"").length>=t?e:pad_left("0"+e,length)}function bookingStatus(e){let t="";switch(+e){case 1:t="已約時間";break;case 2:t="已取消";break;case 3:t="客戶失約";break;case 4:t="已完成看屋";break;default:t="未聯繫"}return t}const $loader=$(".loader"),api={account:"api/account.php",booking:"api/booking.php",email:"api/email.php"},regexer={txt1:/^.{1,}/,txt3:/^.{3,}/,txt8:/^.{8,}/,txt10:/^.{10,}/,txt300:/^.{300,}/,img:/^.{1,}\.(gif|jpg|jpeg|bmp|png)$/,num:/^[1-9]{1}[\d]{0,}/,url:/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:\/?#[\]@!\$&'\(\)\*\+,;=.]+$/,email:/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/};Vue.component("notice",{template:"<div class=\"notice\">\n<strong><slot name='strong'></slot></strong><br>\n<slot name='msg'></slot>\n</div>"});const Justice={list(e=null,t=null){e&&(window.vm=new Vue({el:"#app",data:{page:{now:1,rows:20,total:0,start:0,end:0,last:!1},items:t,itemsOnRange:[],status:{save:null},msg:{save:null}},beforeMount(){var e=this.getParamFromURL("p");e=e||1,this.page.total=Math.ceil(this.items.length/this.page.rows),this.page.rows=this.page.rows>this.items.length?this.items.length:this.page.rows,this.getDataByRangeAfterChanged(e)},methods:{bookingStatus:e=>bookingStatus(e),range:function(e,t){return range(e,t)},getParamsFromURL:function(){var e=location.search;return e=!!(e=e.split("?")[1])&&e.split("&")},getParamFromURL:function(e){var t=this.getParamsFromURL();if(t){var a=!1;return e&&(e+="=",$.each(t,function(t,s){var n=s.match(e);if(n&&!n.index)return a=s.split("=")[1],!1})),+a}},getDataByRangeAfterChanged:function(e){this.page.now=e,this.page.start=(this.page.now-1)*this.page.rows,this.page.end=this.page.start+this.page.rows,this.itemsOnRange=this.items.slice(this.page.start,this.page.end),window.history.pushState(null,null,"?p="+e),$.move2Position(0)},getDataByRangeAfterChanged:function(e){this.page.now=e,this.page.start=(this.page.now-1)*this.page.rows,this.page.end=this.page.start+this.page.rows,this.itemsOnRange=this.items.slice(this.page.start,this.page.end),window.history.pushState(null,null,"?p="+e),$.move2Position(0)},changePageRange:function(e){window.history.pushState(null,null,"?p="+this.page.now);var t=this.getParamsWithoutParam("p");t=t.length?"?"+t+"&":"?",e?location.href=location.origin+location.pathname+t+"p="+this.page.now:this.getDataByRangeAfterChanged(this.page.now)},pageItem:function(e){return e},pageSwitch:function(e){this.page.now=+e},pagePrev:function(){var e=this.page.now;--e<=0&&(e=1),this.getDataByRangeAfterChanged(e)},pageNext:function(){var e=this.page.now;++e>=this.page.total&&(e=this.page.total),this.getDataByRangeAfterChanged(e)},dele:function(t,a,s){var n=this;if(t){var o=api[e]+"?delete="+t;confirm("是否要刪除「"+a+"」這筆資料？")&&$.ajax({type:"GET",url:o,async:!1,error:function(e,t,a){n.status.save="error",n.msg.save=e.responseText,removeSaveMsg(n)},success:function(e){n.status.save="success",n.msg.save="您已成功刪除「"+a+"」這筆資料。",n.items.splice(s,1),removeSaveMsg(n)}})}},downloadXLSX(){const e=this,t=new Date,a="justice_"+t.getFullYear()+pad_left(t.getMonth()+1,2)+pad_left(t.getDay())+pad_left(t.getHours())+pad_left(t.getMinutes())+pad_left(t.getSeconds())+".xlsx",s=e.items,n=XLSX.utils.book_new();let o=[["流水號","客戶姓名","縣市","行政區","職業","聯絡電話","聯絡信箱","客戶訊息","預約狀態","備註"]];for(let t in s){const a=s[t];o.push([a.id,a.name,a.city,a.district,a.job,a.phone,a.email,a.message,e.bookingStatus(a.booking),a.note])}let i=XLSX.utils.aoa_to_sheet(o);for(let e in i){const t=i[e];/^(B|F|I)/.test(e)&&/^(B|F|I)1$/.test(e)&&(t.t="s")}XLSX.utils.book_append_sheet(n,i,"預約看屋"),XLSX.writeFile(n,a)}}}))},handler(e=null,t=null){e&&(window.vm=new Vue({el:"#app",data:{form:{name:"",new_password:null,city_id:"",district_id:"",phone:"",email:"",message:"",note:"",grade:"1",status:"1"},status:{save:null,menu:!1,usableSubmit:!1,email:null},validation:{account:{email:!1,new_password:!1}},validationRules:{email:regexer.email,new_password:regexer.txt8},hasError:{email:!1,new_password:!1},msg:{save:null,email:"這個 Email 已被使用！"},error:{email:!1}},beforeMount(){const a=this;if(t){const s=api[e]+"?read&id="+t;$.ajax({url:s,method:"GET",dataType:"json",async:!1,error:function(e,t,a){console.log(e.responseText)},success:function(t){t="object"==typeof t?t:JSON.parse(t),a.form=t,"booking"===e&&(a.form.area=a.form.city+a.form.district),"account"===e&&(a.form.new_password="")}}),"account"===e&&(delete a.validation.account.new_password,delete a.validationRules.new_password),a.validator()}},methods:{validator:function(){const t=this;let a=!1;$.each(t.validation[e],function(a,s){let n=t.form[a]&&t.validationRules[a].test(t.form[a]);t.validation[e][a]=n,t.hasError[a]=!n}),$.each(t.validation[e],function(e,t){if(a=!0,!t)return a=!1,!1}),t.status.usableSubmit=a},eMailValidator(){const e=this;$.ajax({url:api.email+"?e="+e.form.email,error:function(t,a,s){$loader.removeClass("is:on"),e.status.save="error",e.msg.save=t.responseText,removeSaveMsg(e)},success:function(t){e.error.email=!!+t}})},save(){const a=this;let s=api[e];$loader.addClass("is:on"),s=t?s+"?update&id="+t:s+"?create",$.ajax({url:s,method:"POST",dataType:"json",data:{mData:JSON.stringify(a.form)},async:!1,error:function(e,t,s){$loader.removeClass("is:on"),a.status.save="error",a.msg.save=e.responseText,removeSaveMsg(a)},success:function(e){if($loader.removeClass("is:on"),t)a.status.save="success",a.msg.save="系統已經成功儲存這筆資料！",removeSaveMsg(a);else{var s=null;"number"==typeof e?s=e:"object"==typeof e&&(s=e.new_id),location.href=location.href+"?id="+s}}})},generatePassword(){this.form.new_password=$.Password.generate(12)}}}))},login(){window.vm=new Vue({el:"#app",data:{email:null,password:null,recaptch:null,usableSubmit:!1},methods:{validate(){let e=regexer.email.test(this.email),t=regexer.txt8.test(this.password),a=regexer.txt300.test(this.recaptch);this.usableSubmit=!!(e&&t&&a)}}})},move2Position:function(e,t){$("html, body").stop().animate({scrollTop:e},650,t)},Password:{_pattern:/[\w\!\@\#\$\%\^\&\*\(\)\[\]\{\}\"\'\+\-\,\.\/\:\;\<\>\=\\\`\|\~\?]/,_getRandomByte:function(){if(window.crypto&&window.crypto.getRandomValues){var e=new Uint8Array(1);return window.crypto.getRandomValues(e),e[0]}if(window.msCrypto&&window.msCrypto.getRandomValues){e=new Uint8Array(1);return window.msCrypto.getRandomValues(e),e[0]}return Math.floor(256*Math.random())},generate:function(e){return Array.apply(null,{length:e}).map(function(){for(var e;;)if(e=String.fromCharCode(this._getRandomByte()),this._pattern.test(e))return e},this).join("")}},common(){$(window).on("load",()=>{var e;e=setTimeout(()=>{$("body").addClass("loaded"),$(".loader").addClass("is:off"),clearTimeout(e)},1e3)})}};$.extend(!0,Justice),$.common();
